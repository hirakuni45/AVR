#pragma once
//=====================================================================//
/*!	@file
	@brief	タスク関係
	@author	平松邦仁 (hira@rvf-rc45.net)
*/
//=====================================================================//
#include "switch.hpp"
#include "monograph.hpp"
#include "psound.hpp"
#include "i_task.hpp"

namespace app {

	//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++//
	/*!
		@brief	タスク・クラス
	*/
	//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++//
	class task {
		system::switch_input	swi_;
		device::psound			psound_;
		graphics::monograph		mng_;

		i_task*		task_;
		i_task*		erase_;

	public:
		//-----------------------------------------------------------------//
		/*!
			@brief	コンストラクター
		*/
		//-----------------------------------------------------------------//
		task() : task_(0), erase_(0) { }


		//-----------------------------------------------------------------//
		/*!
			@brief	デストラクター
		*/
		//-----------------------------------------------------------------//
		~task() {
			delete task_;
		}


		//-----------------------------------------------------------------//
		/*!
			@brief	初期化
		*/
		//-----------------------------------------------------------------//
		void init() {
			psound_.init();
			mng_.init();
		}


		//-----------------------------------------------------------------//
		/*!
			@brief	スイッチの参照
		*/
		//-----------------------------------------------------------------//
		system::switch_input& at_switch() { return swi_; }		


		//-----------------------------------------------------------------//
		/*!
			@brief	パルス・サウンドの参照
		*/
		//-----------------------------------------------------------------//
		device::psound& at_psound() { return psound_; }		


		//-----------------------------------------------------------------//
		/*!
			@brief	グラフィックスの参照
		*/
		//-----------------------------------------------------------------//
		graphics::monograph& at_monograph() { return mng_; }


		//-----------------------------------------------------------------//
		/*!
			@brief	タスクの起動
		*/
		//-----------------------------------------------------------------//
		template <class TASK>
		void start() {
			erase_ = task_;
			task_ = new TASK(*this);
			task_->init();
		}


		//-----------------------------------------------------------------//
		/*!
			@brief	サービス
		*/
		//-----------------------------------------------------------------//
		void service() {
			psound_.service();

			if(task_) task_->service();

			if(erase_) {
				erase_->destroy();
				delete erase_;
				erase_ = 0;
			}
		}
	};
}
